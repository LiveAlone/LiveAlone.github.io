<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.yaoqijun.site","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="why so serious">
<meta property="og:type" content="website">
<meta property="og:title" content="joker">
<meta property="og:url" content="http://blog.yaoqijun.site/index.html">
<meta property="og:site_name" content="joker">
<meta property="og:description" content="why so serious">
<meta property="og:locale">
<meta property="article:author" content="joker">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.yaoqijun.site/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>joker</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">joker</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">why so serious</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/12/GCBasic1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/12/GCBasic1/" class="post-title-link" itemprop="url">垃圾回收算法实践 (1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-09-12 00:25:30 / Modified: 01:17:08" itemprop="dateCreated datePublished" datetime="2020-09-12T00:25:30+08:00">2020-09-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" itemprop="url" rel="index"><span itemprop="name">垃圾回收</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/%E7%AE%97%E6%B3%95%E4%B8%8E%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">算法与实践</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>最近阅读了一本书籍，中村成洋的《垃圾回收的算法与实践》，个人最先接收到垃圾回收的是JVM 垃圾回收器, 单线程，多线程， CMS, G1, ZGC 等垃圾回收算法，发现垃圾回收算法的思想比JVM 远远早的多，这本书介绍了一些基本的思想，感觉不错。 JVM 垃圾回收也是踩在前人的肩膀上的，想写写这本书的阅读心得。</p>
<p>GC 定义，Garbage Collection 垃圾回收，1. 寻找内存中的垃圾 2. 回收垃圾，重复利用这部分空间。 没有GC的时候， 程序员需要手动管理内存申请释放，比较麻烦。</p>
<h4 id="对象，头，域"><a href="#对象，头，域" class="headerlink" title="对象，头，域"></a>对象，头，域</h4><ul>
<li>对象头，标记对象的种类，大小，</li>
<li>对象域，存储对象的数据。 基础数据类型，int,double。 指针数据类型，指向地址对象内容。</li>
</ul>
<p>mutator 程序运行状态，伴随对象的生成，指针的更新。 需要与垃圾的回收保持一个相对的平衡，保证程序的正常运行。<br>堆， mutator 程序活动中， 对象的存储空间。<br>活动对象，程序运行通过引用可以触达的对象。非活动对象，程序通过引用无法触达的对象，就是垃圾对象。<br>chunk 分块，对象的大小不同的，不同对象分配不同大小的块，块废弃以后，需要自动回收。<br>Root 根对象，引用的起始位置，java 中常量池，运行栈等等。 统一理解为 $Root</p>
<h4 id="评价标准"><a href="#评价标准" class="headerlink" title="评价标准"></a>评价标准</h4><ul>
<li>吞吐量<ul>
<li>计算方式是 HEAP_SIZ / (GC 回收时间), 相同单位时间里，管理回收区域越大，越好</li>
<li>受到 对象活跃程度，相关的</li>
</ul>
</li>
<li>最大停顿时间<ul>
<li>GC 过程中的 STW 全局停顿时间， 交互型应用比较敏感</li>
</ul>
</li>
<li>堆使用效率<ul>
<li>对象头标记，用于GC, 每个对象都有，占用堆空间。</li>
<li>GC 回收算法，可用的堆内存大小，算法可能限制不能 100% 使用。</li>
</ul>
</li>
<li>访问局部性<ul>
<li>GPU 运行访问内存，三层映射，寄存器 -&gt; 3级CPU缓存 -&gt; 主内存 -&gt; 磁盘内存。 内存读写的 连续性，大大提高数据的读写效率，kafka, rocketMQ 大量数据接收量，基于可连续的写入特性。保证即使落入磁盘，也有类似内存的操作效率。 因此算法垃圾回收，引用对象的局部性， 可以提高程序运行效率方向。</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/09/ServerMonitorBasicCpu2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/09/ServerMonitorBasicCpu2/" class="post-title-link" itemprop="url">虚拟机容器基础监听命令(2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-09-09 00:52:52 / Modified: 17:33:37" itemprop="dateCreated datePublished" datetime="2020-09-09T00:52:52+08:00">2020-09-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%9B%91%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">监控</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%9B%91%E6%8E%A7/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="ss"><a href="#ss" class="headerlink" title="ss"></a>ss</h4><ul>
<li><code>ss -antp &gt; $DUMP_DIR/ss.dump 2&gt;&amp;1</code> Dump 所有的tpc 链接方式</li>
<li><code>ss -s</code> summary  显示 socket 统计信息， 链接数量， 防止端口占用完。<ul>
<li>ss -l 显示本地打开的所有端口</li>
<li>ss -pl 显示每个进程具体打开的socket</li>
<li>ss -t -a 显示所有tcp socket</li>
<li>ss -u -a 显示所有的UDP Socekt</li>
<li>ss -o state established ‘( dport = :smtp or sport = :smtp )’ 显示所有已建立的SMTP连接</li>
<li>ss -o state established ‘( dport = :http or sport = :http )’ 显示所有已建立的HTTP连接</li>
<li>ss -x src /tmp/.X11-unix/* 找出所有连接X服务器的进程</li>
<li>ss -s 列出当前socket详细信息</li>
</ul>
</li>
</ul>
<p>监控端口状态通过网络图片说明，<img src="/images/20200908/io2.png" alt="io2.png"></p>
<p>主动连接端可能的状态有： CLOSED SYN_SEND ESTABLISHED<br>主动关闭端可能的状态有： FIN_WAIT_1 FIN_WAIT_2 TIME_WAIT<br>被动连接端可能的状态有： LISTEN SYN_RECV ESTABLISHED<br>被动关闭端可能的状态有： CLOSE_WAIT LAST_ACK CLOSED</p>
<p>一般情况统计 io wait 等待状态进入关注队列中， 防止端口占用完毕了。</p>
<h4 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h4><p>参数含义</p>
<ul>
<li>a (all)显示所有选项，默认不显示LISTEN相关</li>
<li>t (tcp)仅显示tcp相关选项</li>
<li>u (udp)仅显示udp相关选项</li>
<li>n 拒绝显示别名，能显示数字的全部转化成数字。</li>
<li>l 仅列出有在 Listen (监听) 的服務状态</li>
<li>p 显示建立相关链接的程序名</li>
<li>r 显示路由信息，路由表</li>
<li>e 显示扩展信息，例如uid等</li>
<li>s 按各个协议进行统计</li>
<li>c 每隔一个固定时间，执行该netstat命令。</li>
</ul>
<p>一般使用方式 通过grep 过滤不同端口的监控状态信息。-r 获取路由表配置。netstat -lu -lt -lx 不同监听状态</p>
<h4 id="sar"><a href="#sar" class="headerlink" title="sar"></a>sar</h4><p>系统监控瓶颈分析, todo</p>
<h4 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h4><p>linux 进程资源管理，通过 lsof 列出所有资源列表，<code>lsof -i:8080， lsof -p 1</code> 监听端口，监听进程资源列表，过滤资源列表等。</p>
<p>命令条件, 常用 -i -p</p>
<ul>
<li>-a 列出打开文件存在的进程</li>
<li>-c&lt;进程名&gt; 列出指定进程所打开的文件</li>
<li>-g 列出GID号进程详情</li>
<li>-d&lt;文件号&gt; 列出占用该文件号的进程</li>
<li>+d&lt;目录&gt; 列出目录下被打开的文件</li>
<li>+D&lt;目录&gt; 递归列出目录下被打开的文件</li>
<li>-n&lt;目录&gt; 列出使用NFS的文件</li>
<li>-i&lt;条件&gt; 列出符合条件的进程。（4、6、协议、:端口、 @ip ）</li>
<li>-p&lt;进程号&gt; 列出指定进程号所打开的文件</li>
<li>-u 列出UID号进程详情</li>
<li>-h 显示帮助信息</li>
<li>-v 显示版本信息</li>
</ul>
<p>TYPE 指定文件描述类型， 目录设备， 套接字类型。<br>（1）DIR：表示目录<br>（2）CHR：表示字符类型<br>（3）BLK：块设备类型<br>（4）UNIX： UNIX 域套接字<br>（5）FIFO：先进先出 (FIFO) 队列<br>（6）IPv4：网际协议 (IP) 套接字</p>
<p>FD:  文件描述符类型<br>（1）cwd：表示current work dirctory，即：应用程序的当前工作目录，这是该应用程序启动的目录，除非它本身对这个目录进行更改<br>（2）txt ：该类型的文件是程序代码，如应用程序二进制文件本身或共享库，如上列表中显示的 /sbin/init 程序<br>（3）lnn：library references (AIX);<br>（4）er：FD information error (see NAME column);<br>（5）jld：jail directory (FreeBSD);<br>（6）ltx：shared library text (code and data);<br>（7）mxx ：hex memory-mapped type number xx.<br>（8）m86：DOS Merge mapped file;<br>（9）mem：memory-mapped file;<br>（10）mmap：memory-mapped device;<br>（11）pd：parent directory;<br>（12）rtd：root directory;<br>（13）tr：kernel trace file (OpenBSD);<br>（14）v86  VP/ix mapped file;<br>（15）0：表示标准输入<br>（16）1：表示标准输出<br>（17）2：表示标准错误<br>一般在标准输出、标准错误、标准输入后还跟着文件状态模式：r、w、u等<br>（1）u：表示该文件被打开并处于读取/写入模式<br>（2）r：表示该文件被打开并处于只读模式<br>（3）w：表示该文件被打开并处于<br>（4）空格：表示该文件的状态模式为unknow，且没有锁定<br>（5）-：表示该文件的状态模式为unknow，且被锁定<br>同时在文件状态模式后面，还跟着相关的锁<br>（1）N：for a Solaris NFS lock of unknown type;<br>（2）r：for read lock on part of the file;<br>（3）R：for a read lock on the entire file;<br>（4）w：for a write lock on part of the file;（文件的部分写锁）<br>（5）W：for a write lock on the entire file;（整个文件的写锁）<br>（6）u：for a read and write lock of any length;<br>（7）U：for a lock of unknown type;<br>（8）x：for an SCO OpenServer Xenix lock on part      of the file;<br>（9）X：for an SCO OpenServer Xenix lock on the      entire file;<br>（10）space：if there is no lock.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/07/ServerMonitorBasicCpu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/07/ServerMonitorBasicCpu/" class="post-title-link" itemprop="url">虚拟机容器基础监听命令(1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-07 17:38:23" itemprop="dateCreated datePublished" datetime="2020-09-07T17:38:23+08:00">2020-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-09 01:08:05" itemprop="dateModified" datetime="2020-09-09T01:08:05+08:00">2020-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%9B%91%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">监控</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%9B%91%E6%8E%A7/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="uptime-CPU"><a href="#uptime-CPU" class="headerlink" title="uptime CPU"></a>uptime CPU</h4><p>load average 系统负荷平均统计，单核 CPU 1.0, 系统刚好执行完成所有任务。 通过 <code>cat /proc/cpuinfo, grep -c &#39;model name&#39; /proc/cpuinfo</code> 统计CPU 数量， 一般线上服务 0.7 负载相对有问题了， 需要排查问题原因</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[deploy@sns-jarvis-staging01 ~]$ uptime</span><br><span class="line">19:07:32 (当前时间) up 671 days, 19:46, (运行时间)  2 users,(用户数量)  load average: 49.57, 45.00, 41.24 (平均负载)</span><br></pre></td></tr></table></figure>

<h4 id="vmstat-CPU"><a href="#vmstat-CPU" class="headerlink" title="vmstat CPU"></a>vmstat CPU</h4><p>务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[deploy@sns-jarvis-staging02 ~/cron-mqworker_yqj1]$ vmstat 2</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line">53  0      0 1829688 546056 5312848    0    0    22   103    0    0 27 12 60  0  0</span><br><span class="line">24  0      0 1764004 546056 5312872    0    0     0   196 51070 317194 31 14 55  0  0</span><br><span class="line">71  0      0 1748140 546056 5312880    0    0     0    74 48609 299565 41 12 47  0  0</span><br></pre></td></tr></table></figure>

<ul>
<li>进程相关<ul>
<li>r 运行进程数量, 核对CPU 数量对应</li>
<li>b 阻塞进程数量</li>
</ul>
</li>
<li>内存相关<ul>
<li>swpd 系统内存不够时候， 会置换出内存模块，进入磁盘中， &gt; 0 时候， 说明内存不足了。 通常线上服务是关闭内存置换的。</li>
<li>free 这里空闲内存大小， <strong>注意 不是真实的可用内存，Linux 预先占用所有内存等待比例释放内存</strong> 关注度不高</li>
<li>buffer 缓冲区， 进程读写文件时候，预先写入缓冲区， 什么时候刷入磁盘， 等待操作系统的控制。可以 sync 强制刷盘操作。保证数据录入正确。</li>
<li>cache 为了提高数据读取性能，防止重复读取磁盘造成，程序运行速度下降。</li>
</ul>
</li>
<li>磁盘IO相关<ul>
<li>si so 磁盘中读取，写入虚拟内存的数据大小，大于 0, 同样内存泄露</li>
<li>bi bo 所有的块设备， in, out 数量，接近0，不然IO 过于频繁。</li>
<li>in: cpu 中断次数， cs: cpu 上线文切换次数</li>
<li>us: 用户态CPU 时间比例， sy 系统态时间比率， id cpu 空闲比率。 us + sy + id = 100</li>
<li>wa 系统等待 IO 时间，&gt; 0, IO 影响系统等待</li>
<li>st 容器化系统偷取时间 stolen time</li>
</ul>
</li>
</ul>
<h4 id="mpstat-CPU"><a href="#mpstat-CPU" class="headerlink" title="mpstat CPU"></a>mpstat CPU</h4><p>Multiprocessor Statistics 缩写，监控多线程 CPU 状态。 命令格式 <code>mpstat [-P &#123;cpu|ALL&#125;] [internal [count]]</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[deploy@sns-jarvis-staging02 ~]$ mpstat -P ALL 2 10</span><br><span class="line">Linux 3.10.0-514.10.2.el7.x86_64 (sns-jarvis-staging02)     09/08/2020     _x86_64_    (8 CPU)</span><br><span class="line"></span><br><span class="line">01:10:14 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</span><br><span class="line">01:10:16 AM  all   46.17    0.00   25.54    0.13    0.00    0.19    0.00    0.00    0.00   27.97</span><br><span class="line">01:10:16 AM    0   56.85    0.00   23.35    1.02    0.00    0.00    0.00    0.00    0.00   18.78</span><br><span class="line">01:10:16 AM    1   50.00    0.00   23.98    0.00    0.00    0.00    0.00    0.00    0.00   26.02</span><br><span class="line">01:10:16 AM    2   43.01    0.00   27.46    0.00    0.00    0.00    0.00    0.00    0.00   29.53</span><br><span class="line">01:10:16 AM    3   39.38    0.00   27.98    0.00    0.00    0.00    0.00    0.00    0.00   32.64</span><br><span class="line">01:10:16 AM    4   30.61    0.00   15.82    0.51    0.00    0.51    0.00    0.00    0.00   52.55</span><br><span class="line">01:10:16 AM    5   29.02    0.00   34.20    0.00    0.00    1.04    0.00    0.00    0.00   35.75</span><br><span class="line">01:10:16 AM    6   60.61    0.00   20.71    0.00    0.00    0.00    0.00    0.00    0.00   18.69</span><br><span class="line">01:10:16 AM    7   58.00    0.00   31.50    0.00    0.00    0.50    0.00    0.00    0.00   10.00</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回结果Linux 内核版本， cpu 核数， 和每个CPU 的详细状态信息。 参数含义</p>
<ul>
<li>%user      在internal时间段里，用户态的CPU时间(%)，不包含nice值为负进程  (usr/total)*100</li>
<li>%nice      在internal时间段里，nice值为负进程的CPU时间(%)   (nice/total)*100</li>
<li>%sys       在internal时间段里，内核时间(%)       (system/total)*100</li>
<li>%iowait    在internal时间段里，硬盘IO等待时间(%) (iowait/total)*100</li>
<li>%irq       在internal时间段里，硬中断时间(%)     (irq/total)*100</li>
<li>%soft      在internal时间段里，软中断时间(%)     (softirq/total)*100</li>
<li>%idle      在internal时间段里，CPU除去等待磁盘IO操作外的因为任何原因而空闲的时间闲置时间(%) (idle/total)*100</li>
</ul>
<h4 id="free-MEM"><a href="#free-MEM" class="headerlink" title="free MEM"></a>free MEM</h4><p>内存监控 free -m 监控内存使用情况， 通过M 单位显示内存结构， linux 内存占用思想 used = used - buffer - cached , free = free + buffer = cache 真正内存大小。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[deploy@sns-jarvis-staging02 ~]$ free -m</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:          32013       24718        1618          13        5676        6733</span><br><span class="line">Swap:             0           0           0</span><br></pre></td></tr></table></figure>

<h4 id="iostat-IO"><a href="#iostat-IO" class="headerlink" title="iostat IO"></a>iostat IO</h4><p>iostat方便查看CPU、网卡、tty设备、磁盘、CD-ROM 等等设备的活动情况, 负载信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[deploy@sns-jarvis-staging02 ~]$ iostat</span><br><span class="line">Linux 3.10.0-514.10.2.el7.x86_64 (sns-jarvis-staging02) 09/08/2020 _x86_64_(8 CPU)</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">          27.39    0.00   12.20    0.12    0.00   60.29</span><br><span class="line"></span><br><span class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">vda              30.91       105.07       483.29 8105871565 37285428448</span><br><span class="line">vdb               6.84        65.00       318.41 5014628833 24564686976</span><br><span class="line"></span><br><span class="line">[deploy@sns-jarvis-staging02 ~]$ iostat -x</span><br><span class="line">Linux 3.10.0-514.10.2.el7.x86_64 (sns-jarvis-staging02) 09/08/2020 _x86_64_(8 CPU)</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">          27.39    0.00   12.20    0.12    0.00   60.29</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">vda               0.02    45.59    3.34   27.57   105.07   483.29    38.07     0.01    0.32    5.34    1.73   0.32   0.98</span><br><span class="line">vdb               0.00     4.33    2.33    4.50    65.00   318.40   112.18     0.02    2.73    3.07    2.55   0.46   0.31</span><br></pre></td></tr></table></figure>

<p>命令参数定义<br>-C 显示CPU使用情况<br>-d 显示磁盘使用情况<br>-k 以 KB 为单位显示<br>-m 以 M 为单位显示<br>-N 显示磁盘阵列(LVM) 信息<br>-n 显示NFS 使用情况<br>-p[磁盘] 显示磁盘和分区的情况<br>-t 显示终端和CPU的信息<br>-x 显示详细信息<br>-V 显示版本信息</p>
<p>avg-cpu 这个上面定义相同, 不再说明，网上load 下来的图片 <img src="/images/20200908/io.png" alt="io"></p>
<ul>
<li>rrqm/s， wrqm/s 每秒进行 merge 的读，写操作数量， 就是 rmerge/s，wmerge/s<ul>
<li>说明一下，app 多进程通过 内核调用，写入虚拟文件系统数据。 操作系统通过块设备，bio阻塞写入 或者 IO调度器写入队列，调用驱动写入磁盘中。 这个时候会对相邻块写入进行合并操作。</li>
</ul>
</li>
<li>r/s w/s 每秒完成 IO 的读写次数</li>
<li>rsec/s wsec/s 每秒读写扇区数</li>
<li>rkB/s wkB/s 每秒读写写入 KB 数量</li>
<li>avgrq-sz：平均每次设备IO操作的数据大小（扇区）；平均单次IO大小。</li>
<li>avgqu-sz：平均IO队列长度。</li>
<li>await：从请求磁盘操作到系统完成处理，每次请求的平均消耗时间，包括请求队列等待时间；平均IO响应时间（毫秒）。<ul>
<li>r_await， w_await 读写等待时间</li>
</ul>
</li>
<li>svctm：平均每次设备IO操作的服务时间（毫秒）<ul>
<li>通过图片，操作系统等地时间， 一个是 块设备处理时间</li>
</ul>
</li>
<li>%util：一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比。</li>
</ul>
<p>正常情况下svctm应该是小于await值的，而svctm的大小和磁盘性能有关，CPU、内存的负荷也会对svctm值造成影响，过多的请求也会间接的导致svctm值的增加。await值的大小一般取决于svctm的值和IO队列的长度以及IO请求模式，如果scvtm比较接近await，说明IO几乎没有等待时间；如果await远大于svctm，说明IO请求队列太长，IO响应太慢，则需要进行必要优化。<br>如果%util接近100%，说明产生的IO请求太多，IO系统已经满负荷，该磁盘可能存在瓶颈。<br>队列长度(avgqu-sz)也可作为衡量系统 I/O 负荷的指标，但由于 avgqu-sz 是按照单位时间的平均值，所以不能反映瞬间的 I/O 泛洪，如果avgqu-sz比较大，则说明有大量IO在等待。</p>
<h4 id="top-htop"><a href="#top-htop" class="headerlink" title="top htop"></a>top htop</h4><p>统计CPU 内存的使用率，监控状态是进程， 通过 <code>top -Hp $&#123;processId&#125;</code> 监控运行进程状态。 htop 对应升级版本，进程角度监控运行状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[deploy@sns-jarvis-staging02 ~]$ top</span><br><span class="line">top - 00:26:03 up 893 days, 11:25,  1 user,  load average: 22.49, 22.70, 25.52  （当前时间, 系统运行时间，用户数量，CPU 负载）</span><br><span class="line">Tasks: 343 total,   2 running, 341 sleeping,   0 stopped,   0 zombie  （process 不同状态进程数量）</span><br><span class="line"><span class="meta">%</span><span class="bash">Cpu(s): 43.5 us, 14.6 sy,  0.0 ni, 41.5 id,  0.1 wa,  0.0 hi,  0.3 si,  0.0 st （用户时间， 系统时间， 改变优先级占比， 空闲占比， IO等待，软硬中断）</span></span><br><span class="line">KiB Mem : 32781488 total,  3090220 free, 26196908 used,  3494360 buff/cache （缓存Cache 相关）</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  6007408 avail Mem  （swap 系统硬盘缓存相关）</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 5068 deploy    20   0 3535500 396468  12860 S 222.9  1.2   0:08.84 java</span><br><span class="line">15860 deploy    20   0 6428388 727608      0 S  31.9  2.2  23159:40 java</span><br><span class="line">20794 deploy    20   0 7056876 1.096g  14684 S  13.3  3.5 120:07.32 java</span><br><span class="line"> 3290 deploy    20   0 4609100 559288   3892 S  12.3  1.7   1440:04 java</span><br></pre></td></tr></table></figure>

<ul>
<li>M 按照内存排序，  m 显示内存信息，</li>
<li>P 按照 CPU 使用排序，</li>
<li>T cpu 占用累计时间排序</li>
<li>s 刷新时间间隔，  second  默认单位</li>
<li>K  删除 对应进程。</li>
<li>H thread 线程模式， 监控线程执行状态</li>
</ul>
<h4 id="dmesg"><a href="#dmesg" class="headerlink" title="dmesg"></a>dmesg</h4><p>系统日志监控方式，对于挂了进程， 失败进程监控运行日志。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/07/ServerMonitorBasic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/07/ServerMonitorBasic/" class="post-title-link" itemprop="url">微服务监控排查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-09-07 15:55:09 / Modified: 17:17:19" itemprop="dateCreated datePublished" datetime="2020-09-07T15:55:09+08:00">2020-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%9B%91%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">监控</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>微服务环境下服务之间的依赖变弱，会有防止雪崩，熔断降级策略。同时业务发布回滚策略处理方式。 服务一般部署在虚拟机，容器中，serverless 函数式部署等等。服务经常遇到问题，超时，异常，不可用，阻塞等等。 大概分为业务异常， 业务异常引起的资源服务异常，底层资源服务本身有问题。 监控服务时间状态， 遇到问题，通过登录虚拟机，容器中， 查看虚拟容器的实时参数，判断问题来源, 这样一般可以定位表面原因, 临时处理，但是对于定位问题来源，影响时间困难。历史状态监控工具, 定位异常发生时间，定位问题来源，分析异常产生的比例等等。需要基础设施的支持。</p>
<ul>
<li>实时监控, 相对简单，不需要存储<ul>
<li>资源监控，登录虚拟机，容器，监控内存，CPU, 网络，磁盘 实时统计数据信息。</li>
<li>业务 proecss 通常暴露监控的数据接口， spring actuator 端口获取监控数据。 arthas 业务参数实时调用监控统计。</li>
<li>火焰图很好工具，应用火焰图，资源火焰图等。 快速定位问题产生位置。</li>
</ul>
</li>
<li>历史监控, 通常数据存户7天(es 日志数据存储，promethus 监控数据存储，CAT hive 数据存储)<ul>
<li>日志存储定位<ul>
<li>ELK 日志系统，通常定位 业务异常，process 服务进程异常，特殊用户异常， 过滤定位特殊请求异常。</li>
<li>CAT 对服务业务实时统计，<strong>统计</strong>很重要，不同服务依赖 99 线，异常问题数量统计，具体实例的错误比率等。</li>
<li>SKY WALKING 用来追踪调用链路，对于延时比较高，跨服务很多的， 追踪调用耗时链。</li>
</ul>
</li>
<li>endpoint 落库实时监控数据 (influxdb promethus)<ul>
<li>系统监控， CPU 使用率， 内存使用率，网路输入输出流量，包数量，链接数量，内存分配数量等等。</li>
<li>java 服务来说 jvm 监控， old gc 次数，耗时, 不同带的内存大小，占比，线程数量， 直接内存大小等等。</li>
<li>redis ops 数量，分类统计，内存使用数量， 主从同步情况，输入输出流量，线程数量， 客户端链接数量等等</li>
<li>envoy, golang 等等 不同 process, 协程，耗时 等等监控。</li>
<li>业务服务来说，接口请求量，错误率，延时(不同比率延时)。 依赖的redis mq, mysql, 三方服务， http 等等 错误率，延时，QPS 监控。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>个人统计了一些基础监控方式，使用过的，后面想对实时监控命令进行梳理。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/03/SpringBeanFactoryPostProcessor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/03/SpringBeanFactoryPostProcessor/" class="post-title-link" itemprop="url">bean factory processor</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-03 20:56:43" itemprop="dateCreated datePublished" datetime="2020-09-03T20:56:43+08:00">2020-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-07 02:45:45" itemprop="dateModified" datetime="2020-09-07T02:45:45+08:00">2020-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SpringBeanFactoryProcessor 初始化BeanFactory, 读取不同的Source 来源的配置文件， 解析 AnnotationClass 注入 BeanDefinition。<br>通过 <code>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors()</code> 方法，执行BeanFactoryProcessor。</p>
<p>首先执行 <code>BeanDefinitionRegistryPostProcessor</code>，通过注释，注册更多的BeanDefinition, 在正式的BeanFactoryPostProcessor执行之前。</p>
<p>SharedMetadataReaderFactoryContextInitializer$CachingMetadataReaderFactoryPostProcessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册 intereralCacheingMetadataReaderFactory bean definition</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">&quot;org.springframework.boot.autoconfigure.&quot;</span></span><br><span class="line">        + <span class="string">&quot;internalCachingMetadataReaderFactory&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    BeanDefinition definition = BeanDefinitionBuilder</span><br><span class="line">            .genericBeanDefinition(SharedMetadataReaderFactoryBean.class, SharedMetadataReaderFactoryBean::<span class="keyword">new</span>)</span><br><span class="line">            .getBeanDefinition();</span><br><span class="line">    registry.registerBeanDefinition(BEAN_NAME, definition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册Bean 是类型 SharedMetadataReaderFactoryBean， 这是一个FactoryBean, bean 工厂， getObject 通过 <code>ConcurrentReferenceCachingMetadataReaderFactory(classLoader)</code> 创建只一个 ConfigurationClassPostProcessor。 具体Bean 解析过程后面说。</p>
<p>ConfigurationClassPostProcessor 执行 BeanFactoryPostProcessor 处理方式， <code>org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions</code> 解析BeanDefinition</p>
<ol>
<li>解析查找 ConfigBean, bootApplicaitonConfigBean，自定义 @SpringApplicationContext bean。</li>
<li>do-while 循环解析， @configuration 注解， 注入对应的 BeanDefinition 内容， 完成 BeanDefiniotnRegister 初始化。</li>
</ol>
<p>PS: 这个时候 getBean 初始化Bean 对象， 并没有注册 BeanPostProcessor, 等待 Definition 解析完成以后， 初始化所有的 BeanPostProcessor。<br>之前的BeanFactoryProcessor 中部分监听，已经添加了 BeanPostProcessor, 解析 BeanDefinition 以后，重新获取 BeanPostProcessor, 进行初始化。<br>后面 init singleton， 保证数据的正确解析方式。</p>
<hr>
<p>BeanDefinition 继承关系 <img src="/images/20200905/BeanDefinition.png" alt="BeanDefinition"></p>
<p>BeanDefinition 继承制 AttributeAccessor， BeanMetadataElement 提供属性获取, MetadataObject对象原数据获取。提供实例化方式，sigleton, prototype。 bean 类型框架服务，业务类型等。 Bean 名称，属性，构造等。 依赖Bean 等信息。<br>AnnotatedBeanDefinition 注解方式配置Bean，支持获取 AnnotationMetadata 注解配置信息。</p>
<p>AbstractBeanDefinition 抽象Bean定义， 公用字段， 定义构造函数，构造方法，sourceObject 等。</p>
<ul>
<li>RootBeanDefinition 多BeanDefinition 支持合并， 多BeanDefinition 可能存在继承关系。</li>
<li>ChildBeanDefinition 子类 BeanDefinition 类型，parentName 父类对象名称</li>
<li>GenericBeanDefinition 通用，parentName.<ul>
<li>AnnotatedGenericBeanDefinition 注解类型Bean 定义方式</li>
<li>ScannedGenericBeanDefinition 基于ASM ClassLoader</li>
<li>ConfigurationPropertiesValueObjectBeanDefinition 定义类型,  属性注入配置方式。</li>
</ul>
</li>
</ul>
<p>internalCachingMetadataReaderFactory BeanDefinition 构建方式, 可以看到通过构建 <code>org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory SharedMetadataReaderFactoryBean.Class</code> factoryBean进入Definition</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  register(registry);</span><br><span class="line">  configureConfigurationClassPostProcessor(registry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">  BeanDefinition definition = BeanDefinitionBuilder</span><br><span class="line">      .genericBeanDefinition(SharedMetadataReaderFactoryBean.class, SharedMetadataReaderFactoryBean::<span class="keyword">new</span>)</span><br><span class="line">      .getBeanDefinition();</span><br><span class="line">  registry.registerBeanDefinition(BEAN_NAME, definition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureConfigurationClassPostProcessor</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    BeanDefinition definition = registry</span><br><span class="line">        .getBeanDefinition(AnnotationConfigUtils.CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME);</span><br><span class="line">    definition.getPropertyValues().add(<span class="string">&quot;metadataReaderFactory&quot;</span>, <span class="keyword">new</span> RuntimeBeanReference(BEAN_NAME));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 internalCachingMetadataReaderFactory(SharedMetadataReaderFactoryBean) BeanDefinition 获取 实例Bean, <code>org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</code> 获取实例化Bean 对象初始化内容。获取 <code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton()</code> 获取实例的Instance, 通过实例获取 Object <code>org.springframework.beans.factory.support.AbstractBeanFactory#getObjectForBeanInstance</code> getBean 后面详细说明</p>
<p>获取ConfigClassPostProcessor 执行 processConfigBeanDefinitions 注册BeanDefinition。 通过Class 名称可以了解， 解析@Configuration 注解Class 类，加载配置。 <code>org.springframework.context.annotation.ConfigurationClassParser</code> 创建ConfigurationParse 转换类型。 通过 <code>ConfigurationClassBeanDefinitionReader</code> 读取ClassConfig 定义BeanDefinition。</p>
<p>org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClass 处理 Import ComponeScan 不同注解Bean 扫描加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> SourceClass <span class="title">doProcessConfigurationClass</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ConfigurationClass configClass, SourceClass sourceClass, Predicate&lt;String&gt; filter)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;</span><br><span class="line">    <span class="comment">// Recursively process any member (nested) classes first</span></span><br><span class="line">    processMemberClasses(configClass, sourceClass, filter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line">  <span class="keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">      sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">      org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">      processPropertySource(propertySource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +</span><br><span class="line">          <span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process any @ComponentScan annotations</span></span><br><span class="line">  Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">      sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">  <span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">      !<span class="keyword">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">      <span class="comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span></span><br><span class="line">      Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">          <span class="keyword">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">      <span class="comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span></span><br><span class="line">      <span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">        BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">        <span class="keyword">if</span> (bdCand == <span class="keyword">null</span>) &#123;</span><br><span class="line">          bdCand = holder.getBeanDefinition();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="keyword">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">          parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process any @Import annotations</span></span><br><span class="line">  processImports(configClass, sourceClass, getImports(sourceClass), filter, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line">  AnnotationAttributes importResource =</span><br><span class="line">      AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">  <span class="keyword">if</span> (importResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String[] resources = importResource.getStringArray(<span class="string">&quot;locations&quot;</span>);</span><br><span class="line">    Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass(<span class="string">&quot;reader&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (String resource : resources) &#123;</span><br><span class="line">      String resolvedResource = <span class="keyword">this</span>.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">      configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process individual @Bean methods</span></span><br><span class="line">  Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">  <span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">    configClass.addBeanMethod(<span class="keyword">new</span> BeanMethod(methodMetadata, configClass));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process default methods on interfaces</span></span><br><span class="line">  processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process superclass, if any</span></span><br><span class="line">  <span class="keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">    String superclass = sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">    <span class="keyword">if</span> (superclass != <span class="keyword">null</span> &amp;&amp; !superclass.startsWith(<span class="string">&quot;java&quot;</span>) &amp;&amp;</span><br><span class="line">        !<span class="keyword">this</span>.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">      <span class="comment">// Superclass found, return its annotation metadata and recurse</span></span><br><span class="line">      <span class="keyword">return</span> sourceClass.getSuperClass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// No superclass -&gt; processing is complete</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换 ClassConfig 获取BeanConfigutration 配置内容， BeanFactory 转换Bean 类型。</p>
<hr>
<p>BeanFactory getBean 通过BeanDefinition 初始化Bean 实例配置。 <code>org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</code> 作为入口解析Spring 获取 Bean 过程。</p>
<ul>
<li>transformedBeanName beanName转换，两件事情 1. &amp; Spring内置Bean名称获取转换 2. 通过aliasName 依赖名称转换。</li>
<li>获取ParentBeanFactory 父级工厂， 和Class 加载机制类似， 优先父级 GetBean, 存在返回。</li>
<li>获取 BeanNameDefinition 定义类型</li>
<li>获取 BeanDefinition 依赖 DependOn, 1. 注册依赖Bean  2. getBean 方式实例化依赖bean 类型。</li>
<li>创建当前 Bean 实例， 通过 BeanDefinition 判断 Bean 类型<ul>
<li>Singleton ProtoType 通过 GetBean 获取实例Bean 类型</li>
<li>用户支持自定义 Scope 通过Scope 自定义 Bean 的作用域范围</li>
</ul>
</li>
</ul>
<p>通过监控<code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean()</code> Bean初始化过程， BeanPostProcessor 不同的继承实现接口, <code>DestructionAwareBeanPostProcessor, InstantiationAwareBeanPostProcessor, MergedBeanDefinitionPostProcessor</code> 不同初始化接口， 返回对象类型。</p>
<p>对象注入， init 初始化 等等 不同的处理类型， 都是通过 Processor, 具体感觉使用查看， 毕竟分析也记不住。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/02/SpringApplicationContext2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/02/SpringApplicationContext2/" class="post-title-link" itemprop="url">SpringApplicationContext2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-02 00:40:26" itemprop="dateCreated datePublished" datetime="2020-09-02T00:40:26+08:00">2020-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-07 01:11:40" itemprop="dateModified" datetime="2020-09-07T01:11:40+08:00">2020-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SpringContext Refresh 刷新所有的启动配置, AbstractApplicationContext 刷新所有的配置列表内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        prepareRefresh();</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            initMessageSource();</span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line">            onRefresh();</span><br><span class="line">            registerListeners();</span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">            destroyBeans();</span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">            <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">            resetCommonCaches();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>prepare refesh, Context 加载预先准备</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Switch to active.</span></span><br><span class="line">    <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Refreshing &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Refreshing &quot;</span> + getDisplayName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initPropertySources(); <span class="comment">// 初始化PropertySource资源, AbstractApplicationContext 是一个空实现， 不同Context 自定义添加Source 资源来源</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate that all properties marked as required are resolvable:</span></span><br><span class="line">    <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line">    getEnvironment().validateRequiredProperties();  <span class="comment">// 验证</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 early earlyApplicationListeners，earlyApplicationEvents 监听事件类型</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.earlyApplicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.applicationListeners);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">        <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">        <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">    <span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>obtainFreshBeanFactory() 获取BeanFactory。 AbstractionContext 通知继承者， refreshBeanFactory 回调。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加了 Aware BeanPostProcessor 忽略所有的 Aware</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定 bean 依赖 Class 固定的对象类型</span></span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册 loadTimeWeaver bean PostProcessor, class load 的编制, 特殊场景使用， 我没见用过</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">        <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册特殊Bean</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="bean-factory-processor"><a href="#bean-factory-processor" class="headerlink" title="bean factory processor"></a>bean factory processor</h5><p>执行 BeanFactoryPorcessor bean factory 处理器执行过程。<code>postProcessBeanFactory(beanFactory);</code> subclass处理执行BeanFactory， 然后执行 <code>invokeBeanFactoryPostProcessors(beanFactory);</code> bean Factory Processor。</p>
<p>invoker 执行BeanFactoryPostProcesser, static 方法，初始化loader 相关BeanDefinition 内容。</p>
<ul>
<li>SharedMetadataReaderFactoryContextInitializer$CachingMetadataReaderFactoryPostProcessor</li>
<li>ConfigurationWarningsApplicationContextInitializer$ConfigurationWarningsPostProcessor</li>
<li>ConfigFileApplicationListener$PropertySourceOrderingPostProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">    BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 预先注册 区分出了 BeanFactoryProcessor 和 BeanDefinitionProcessor, definition 预先执行</span></span><br><span class="line">    <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">        <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">            BeanDefinitionRegistryPostProcessor registryProcessor =</span><br><span class="line">                    (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">            registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">            registryProcessors.add(registryProcessor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            regularPostProcessors.add(postProcessor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bean factory 获取 BeanDefinitionRegistryPostProcessor, 这个时候获取Class 循环解析结果</span></span><br><span class="line">    List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">    registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新获取BeanDefinition 解析 Bean, </span></span><br><span class="line">    postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">            processedBeans.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">    registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后循环执行, 直到没有新的BeanDefinitionRegistryPostProcessor 产生以后结束</span></span><br><span class="line">    <span class="keyword">boolean</span> reiterate = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">        reiterate = <span class="keyword">false</span>;</span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">                reiterate = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后执行 BeanFactoryProcessor, 包含对BeanDefinition 增强， 添加BeanPostProcessor</span></span><br><span class="line">    invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">    invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后面会重新获取 BeanFactoryPostProcessor，刚刚BeanDefinition, BeanFactoryProcessor 可能影响了 BeanFactory 中 BeanFactoryProcessor 数据集合。<br>最后执行 priorityOrderedPostProcessors, orderedBeanFactoryPostProcessor,nonOrderedPostProcessors 顺序执行列表。<br>上面BeanFactoryProcessor 执行完成了， 初始化一些BeanDefinition 内容。</p>
<h4 id="registerBeanPostProcessors-注册BeanPostProcessor"><a href="#registerBeanPostProcessors-注册BeanPostProcessor" class="headerlink" title="registerBeanPostProcessors 注册BeanPostProcessor"></a>registerBeanPostProcessors 注册BeanPostProcessor</h4><p>区分三种类型 priorityOrderedPostProcessors，internalPostProcessors，orderedPostProcessorNames，nonOrderedPostProcessorNames。<br>这些Processor 执行顺序, priorityOrderedPostProcessors &gt; orderedPostProcessors &gt; nonOrderedPostProcessors &gt; internalPostProcessors<br>internalPostProcessors 对于类型是 MergedBeanDefinitionPostProcessor，包含前三个集合数据， bean 实例化以后， 对齐合并定义， 对BeanPostProcessor 的扩充。</p>
<p>initMessageSource 初始化 MessageSource bean, initApplicationEventMulticaster 注册消息分发对象。</p>
<p>这个时候 BeanFactory 初始化基本已经完成了， BeanDefinition 资源已经加载完毕了， 但是 并没有初始化 创建Bean。所以，下面 OnRefresh() 不同的 App 实现不同的扩展模块， web 实现 tomcat 服务启动 等等。 registerListeners() 完成不同 ApplicationListener bean 注册factory 中。 <code>finishBeanFactoryInitialization(beanFactory);</code> 立即初始化所有的单例Bean。 FinishRefresh() 事件分发，初始化一下 lifecycleBean。 最后清理所有 Cache 解析缓存。<br><code>beanFactory.preInstantiateSingletons</code> init singletion bean，依赖BeanDefinition 执行init 方法, SmartInitializingSingleton 等等。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/01/SpringApplicationContext1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/01/SpringApplicationContext1/" class="post-title-link" itemprop="url">SpringApplicationContext1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-01 15:04:17" itemprop="dateCreated datePublished" datetime="2020-09-01T15:04:17+08:00">2020-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-02 00:37:44" itemprop="dateModified" datetime="2020-09-02T00:37:44+08:00">2020-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ApplicationContext 数据创建build, SpringApplication 不同的服务类型， 创建不同的ApplicationContext。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CONTEXT_CLASS = <span class="string">&quot;org.springframework.context.&quot;</span></span><br><span class="line">        + <span class="string">&quot;annotation.AnnotationConfigApplicationContext&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SERVLET_WEB_CONTEXT_CLASS = <span class="string">&quot;org.springframework.boot.&quot;</span></span><br><span class="line">        + <span class="string">&quot;web.servlet.context.AnnotationConfigServletWebServerApplicationContext&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_REACTIVE_WEB_CONTEXT_CLASS = <span class="string">&quot;org.springframework.&quot;</span></span><br><span class="line">        + <span class="string">&quot;boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>Spring BeanUtils 初始化 org.springframework.context.annotation.AnnotationConfigApplicationContext, init constructor。 ApplicationContext 继承来自 BeanFactory 接口继承关系 <img src="/images/20200901/BeanFactory.png" alt="BeanFactory"></p>
<ul>
<li>BeanFactory spring bean 管理工厂<ul>
<li>ListableBeanFactory 支持通过Name Class Annotation 获取BeanList 遍历查询操作</li>
<li>HierarchicalBeanFactory BeanFactory 继承关系<ul>
<li>ConfigurableBeanFactory, ConfigurableListableBeanFactory 配置化 benaFactory 工厂</li>
</ul>
</li>
<li>AutowireCapableBeanFactory 自动注入非Spring 管理Bean 类型</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContext</span> <span class="keyword">extends</span> <span class="title">EnvironmentCapable</span>, <span class="title">ListableBeanFactory</span>, <span class="title">HierarchicalBeanFactory</span>,</span></span><br><span class="line"><span class="class">    <span class="title">MessageSource</span>, <span class="title">ApplicationEventPublisher</span>, <span class="title">ResourcePatternResolver</span> </span>&#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ApplicationContext 继承了 BeanFactory,EventPublisher,ResourceLoader,MessageSource 上下列表。 ApplicationContext 继承接口实现 <img src="/images/20200901/ApplicationContext.png" alt="ApplicationContext"></p>
<ul>
<li>ConfigurableApplicationContext 基础实现，支持 add BeanFactoryPostProcessor, beanFactory 处理器添加<ul>
<li>WebServerApplicationContext, ReactiveWebApplicationContext web page 上下文， WebServer 服务获取<ul>
<li>ConfigurableWebServerApplicationContext，ConfigurableReactiveWebApplicationContext webApplicationContext上下文支持</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>不同ApplicationContext 上下文的实现环境 <img src="/images/20200901/AbstractApplicationContext.png" alt="AbstractApplicationContext"></p>
<p>AnnotationConfigApplicationContext applicationContext bean 上下文定义注册方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfigApplicationContext</span> <span class="keyword">extends</span> <span class="title">GenericApplicationContext</span> <span class="keyword">implements</span> <span class="title">AnnotationConfigRegistry</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnnotatedBeanDefinitionReader reader; <span class="comment">// annotation 注册使用BeanDefinition</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassPathBeanDefinitionScanner scanner;   <span class="comment">// scanner 扫描对应的 package 加载 Bean 定义方式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringApplication 核心Context <code>prepareContext, refreshContext, afterRefresh</code> context 配置修改</p>
<h5 id="prepareContext-context"><a href="#prepareContext-context" class="headerlink" title="prepareContext() context"></a>prepareContext() context</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(ConfigurableApplicationContext context, ConfigurableEnvironment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">        SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner)</span> </span>&#123;</span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">    beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="keyword">null</span>) &#123;</span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">        ((DefaultListableBeanFactory) beanFactory)</span><br><span class="line">                .setAllowBeanDefinitionOverriding(<span class="keyword">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.lazyInitialization) &#123;</span><br><span class="line">        context.addBeanFactoryPostProcessor(<span class="keyword">new</span> LazyInitializationBeanFactoryPostProcessor());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Load the sources</span></span><br><span class="line">    Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">    Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">    load(context, sources.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>postProcessApplicationContext(context) 预处理相关ApplicationContext, 设置BeanNameGenerate, resourceLoader, ConversionService 配置Bean 属性Config。</li>
<li>ApplicationContextInitializer context 环境初始化， 下面会详细讲述</li>
<li>执行 ApplicationListeners 线程同步执行监听器, 发放 ContextPreparedEvent 提供监听。</li>
<li>注册 <code>springApplicationArguments, springBootBanner</code> application Spring bean 对象</li>
<li>allowBeanDefinitionOverriding 默认true， 定义false， 不允许同名BeanDefinition 覆盖操作。</li>
<li>load beans to ApplicationContext， app 上下文加载beans</li>
<li>contextedLoaded 事件监听分发</li>
</ol>
<p>不同的Listener 注册对应的Bean， 但是不希望直接操作 ApplicationContext, 通过添加BeanFactoryProcessor, 走正常的 ApplicationContext 初始化流程。</p>
<h5 id="ApplicationContextInitializer-context-初始化"><a href="#ApplicationContextInitializer-context-初始化" class="headerlink" title="ApplicationContextInitializer context 初始化"></a>ApplicationContextInitializer context 初始化</h5><p>通过 spring.factory 配置文件， 获取 ApplicationContextInitializer 初始化Bean。 initApplicationContext 包含</p>
<ul>
<li>DelegatingApplicationContextInitializer <code>context.initializer.classes</code> 执行这些用户定制化的 init class bean</li>
<li>SharedMetadataReaderFactoryContextInitializer 添加 CachingMetadataReaderFactoryPostProcessor beanPostProcessor</li>
<li>ContextIdApplicationContextInitializer 初始化ContextId, 设置ApplicationContext ContextId, 注册Bean</li>
<li>ConfigurationWarningsApplicationContextInitializer 添加 ConfigurationWarningsPostProcessor</li>
<li>RSocketPortInfoApplicationContextInitializer 添加 RSocketServerInitializedEvent rsocket 初始化监听事件</li>
<li>ServerPortInfoApplicationContextInitializer WebServerInitializedEvent webServer 事件监听。</li>
<li>ConditionEvaluationReportLoggingListener ConditionEvaluationReportListener 添加Listener</li>
</ul>
<p>可以看到，执行初始化监听者时候， 注入不同的 Processor Listener， ApplicaitonContext 本身留有很多 hook， 执行定制化需求。</p>
<h4 id="applicationContext-load-resources"><a href="#applicationContext-load-resources" class="headerlink" title="applicationContext load resources"></a>applicationContext load resources</h4><p>AnnotationBean 注册启动Class, BootDemoApplication(用户自定义启动bean类型)， 通过Class 注册第一个 BeanDefinition 定义类型。</p>
<h4 id="refresh-application-context"><a href="#refresh-application-context" class="headerlink" title="refresh application context"></a>refresh application context</h4><p>刷新application context 这里会 load 所有的Bean，完整执行流程， 后面沟通</p>
<h4 id="after-refresh"><a href="#after-refresh" class="headerlink" title="after refresh"></a>after refresh</h4><p>customer 自定义继承实现， 这个时候， application 已经完成 Context 完成加载。 这个地方个人理解， 是一个和 ApplicationContext(BeanFactory) 不相关的一个初始化。 其实在 ApplicaitonContext 中， 也会有Hook, customer 自定义容器相关的初始化。 FIN</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/09/01/SpringEnvConfig2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/01/SpringEnvConfig2/" class="post-title-link" itemprop="url">Spring Environment Config 2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-09-01 01:38:10 / Modified: 14:32:14" itemprop="dateCreated datePublished" datetime="2020-09-01T01:38:10+08:00">2020-09-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>想说明一下 Spring Enviroment 加载不同来源的 配置文件。</p>
<h5 id="Spring-内置事件分发器"><a href="#Spring-内置事件分发器" class="headerlink" title="Spring 内置事件分发器"></a>Spring 内置事件分发器</h5><p>SpringApplicationRunnerListener 之前在 spring.factories 配置 EventPublishingRunListener, 负责事件发放</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run Listeners</span></span><br><span class="line"><span class="string">org.springframework.boot.SpringApplicationRunListener=\</span></span><br><span class="line"><span class="string">org.springframework.boot.context.event.EventPublishingRunListener</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventPublishingRunListener</span><span class="params">(SpringApplication application, String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.application = application;</span><br><span class="line">    <span class="keyword">this</span>.args = args;</span><br><span class="line">    <span class="keyword">this</span>.initialMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster();</span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : application.getListeners()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.initialMulticaster.addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过构造函数, 通过 application 获取ApplicationListener 事件监听对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationListener</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(E event)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationEvent</span> <span class="keyword">extends</span> <span class="title">EventObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7099057708183571937L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timestamp;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationEvent</span><span class="params">(Object source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">        <span class="keyword">this</span>.timestamp = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">getTimestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到事件监听者， 通过继承ApplicationListener 实现对应的事件监听， 监听事件类型 ApplicaiotnEvent, spring 通过 spring.factory 获取所有的 Listeners, <strong>这个时候SpringFactory 还没有启动，Listener Bean 不会Env 初始化中进行</strong>， ApplicationListener 通过监听参数 Class 类型进行事件分发，很巧妙，参考 <code>org.springframework.context.event.SimpleApplicationEventMulticaster</code> 实现方式。</p>
<p>下面我们看看 Env 初始化需要执行的 Listeners, event 类型 <code>ApplicationEnvironmentPreparedEvent</code>, listeners 包含</p>
<ul>
<li>ConfigFileApplicationListener</li>
<li>AnsiOutputApplicationListener</li>
<li>LoggingApplicationListener</li>
<li>ClasspathLoggingApplicationListener</li>
<li>BackgroundPreinitializer</li>
<li>DelegatingApplicationListener</li>
<li>LocalApplicationListener</li>
<li>FileEncodingApplicationListener</li>
</ul>
<p>ConfigFileApplicationListener 注入监听数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationEnvironmentPreparedEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>&#123;</span><br><span class="line">    List&lt;EnvironmentPostProcessor&gt; postProcessors = loadPostProcessors();</span><br><span class="line">    postProcessors.add(<span class="keyword">this</span>);</span><br><span class="line">    AnnotationAwareOrderComparator.sort(postProcessors);</span><br><span class="line">    <span class="keyword">for</span> (EnvironmentPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">        postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">List&lt;EnvironmentPostProcessor&gt; <span class="title">loadPostProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor.class, getClass().getClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过SpringFactoryLoad 对应 EnvironmentPostProcessor 处理不同的文件加载load, load processor 包括:</p>
<ul>
<li>SystemEnvironmentPropertySourceEnvironmentPostProcessor</li>
<li>SpringApplicationJsonEnvironmentPostProcessor</li>
<li>CloudFoundryVcapEnvironmentPostProcessor</li>
<li>ConfigFileApplicationListener</li>
<li>DebugAgentEnvironmentPostProcessor</li>
<li>SpringBootTestRandomPortEnvironmentPostProcessor</li>
</ul>
<p>ConfigFileApplicationListener 添加配置文件 PropertySource 配置资源文件，加载配置方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addPropertySources</span><span class="params">(ConfigurableEnvironment environment, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">    RandomValuePropertySource.addToEnvironment(environment);</span><br><span class="line">    <span class="keyword">new</span> Loader(environment, resourceLoader).load();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loader 初始化</span></span><br><span class="line">Loader(ConfigurableEnvironment environment, ResourceLoader resourceLoader) &#123;</span><br><span class="line">    <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    <span class="keyword">this</span>.placeholdersResolver = <span class="keyword">new</span> PropertySourcesPlaceholdersResolver(<span class="keyword">this</span>.environment);</span><br><span class="line">    <span class="keyword">this</span>.resourceLoader = (resourceLoader != <span class="keyword">null</span>) ? resourceLoader : <span class="keyword">new</span> DefaultResourceLoader(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.propertySourceLoaders = SpringFactoriesLoader.loadFactories(PropertySourceLoader.class,</span><br><span class="line">            getClass().getClassLoader());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spring.factories</span></span><br><span class="line"># PropertySource Loaders</span><br><span class="line">org.springframework.boot.env.PropertySourceLoader=\</span><br><span class="line">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span><br><span class="line">org.springframework.boot.env.YamlPropertySourceLoader</span><br></pre></td></tr></table></figure>

<p>上面loader 初始化，通过SpringFactory 获取 PropertySourceLoader 配置文件加载类目， 可以看到 properties xml， yaml yml, 配置文件加载。 <code>org.springframework.boot.context.config.ConfigFileApplicationListener.Loader</code> 加载配置文件，结合但是 profile， 相对复杂，专题沟通。 所以， 配置环境中扩展配置，可以 spring.factories 继承PropertySourceLoader 实现配置load, 或者自定义 Env Listener 插入对应 PropertySource 资源。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/08/30/SpringEnvConfig1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/30/SpringEnvConfig1/" class="post-title-link" itemprop="url">Spring Environment Config 1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-30 22:16:00" itemprop="dateCreated datePublished" datetime="2020-08-30T22:16:00+08:00">2020-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-01 01:33:36" itemprop="dateModified" datetime="2020-09-01T01:33:36+08:00">2020-09-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇大概了解了 SpringApplication.Run() 运行初始化过程， 这次了解 EnviromentConfig 配置初始化。</p>
<h4 id="propertySource-资源管理"><a href="#propertySource-资源管理" class="headerlink" title="propertySource 资源管理"></a>propertySource 资源管理</h4><p>application 初始化时候， 创建DefaultApplicationArguments args 启动参数分装， 内部会对 args 分装PropertySource。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertySource</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String name; <span class="comment">// source 配置资源的名称</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> T source;   <span class="comment">// 资源配置类型, properties map 等等, MustableProperty 管理 name - sourceProperty 映射关系。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面展示PropertySource 集成关系图片, 我们解析不同继承链实现方式。<br><img src="/images/20200831/PropertySource.png" alt="SourceProperty"></p>
<ul>
<li>StubPropertySource source 为null 站位资源类型<ul>
<li>ComparisonPropertySource 为了集合比较 Source 资源类型</li>
</ul>
</li>
<li>FilteredPropertySource PropertSource 封装， 包含一个 FilsterSet, 过滤PropertySource 中部分属性不可见</li>
<li>ConfigurationPropertySourcesPropertySource 对 ConfigurationPropertySourcesPropertySource list 封装， 通过这个集成多souce 来源</li>
<li>EnumerablePropertySource 我们知道 source 资源 T 抽象类型， Enum 定义 sourceName 可枚举比较<ul>
<li>CompositePropertySource 多source来源组合封装方式</li>
<li>DynamicValuesPropertySource source 抽象类型 <code>Map&lt;String, Supplier&lt;Object&gt;&gt;</code> 通过Supplier customer 自定提供对象逻辑</li>
<li>CommandLinePropertySource，SimpleCommandLinePropertySource 这里 命令行参数 a=b,b=c 装换Source 格式化数据结构</li>
<li>MapPropertySource source 定义类型 <code>Map&lt;String, Object&gt;</code><ul>
<li>SystemEnvironmentPropertySource 系统配置Property 做一些参数名格式转换</li>
<li>PropertiesPropertySource， JsonPropertySource， spring source 格式管理， 后面详细说明。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Environment-配置环境上下文Context"><a href="#Environment-配置环境上下文Context" class="headerlink" title="Environment 配置环境上下文Context"></a>Environment 配置环境上下文Context</h4><p>Spring通过 Enviroment 管理启动环境上下文配置信息，profile 激活环境配置，不同Source Config yaml 配置来源。<br>Environment 继承关系关系图片 <img src="/images/20200831/PropertyResolver.png" alt="PropertyResolver"></p>
<p>相关接口实现方式</p>
<ul>
<li>PropertyResolver 底层通过 PropertySource 支持 Property 属性获取<ul>
<li>Environment 不同 profiles，理解激活环境，不同配置。@Profile 注解提供支持环境<ul>
<li>ConfigurableEnvironment 支持配置换环境注入， profile 动态激活，MutablePropertySources 底层依赖，支持 merge(env) 多ConfigurableEnvironment 组合<ul>
<li>ConfigurableReactiveWebEnvironment web 环境env</li>
</ul>
</li>
</ul>
</li>
<li>ConfigurablePropertyResolver ConversionService 用户定制化 source 对象转换</li>
</ul>
</li>
</ul>
<p>实现类型</p>
<ul>
<li>AbstractEnvironment 抽象env 实现对象<ul>
<li>StandardEnvironment MutablePropertySource 多资源属性配置</li>
<li>StandardReactiveWebEnvironment web reactive</li>
</ul>
</li>
</ul>
<p>笔记环境创建StandardEnvironment对象, SpringApplication 初始化创建 Env 过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">    ApplicationArguments applicationArguments)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Create and configure the environment</span></span><br><span class="line">  ConfigurableEnvironment environment = getOrCreateEnvironment(); <span class="comment">// 当前App 类型， 创建对应的Env</span></span><br><span class="line">  configureEnvironment(environment, applicationArguments.getSourceArgs()); <span class="comment">// SpringApplication 添加添加环境启动一些 Env 配置信息</span></span><br><span class="line">  ConfigurationPropertySources.attach(environment);   <span class="comment">// 移除 attach properties 后面说</span></span><br><span class="line">  listeners.environmentPrepared(environment);   <span class="comment">// 通过 applicationListener env 加载对应的EnvProcessor</span></span><br><span class="line">  bindToSpringApplication(environment); <span class="comment">// 额外绑定操作等等</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">    environment = <span class="keyword">new</span> EnvironmentConverter(getClassLoader()).convertEnvironmentIfNecessary(environment,</span><br><span class="line">        deduceEnvironmentClass());</span><br><span class="line">  &#125;</span><br><span class="line">  ConfigurationPropertySources.attach(environment);</span><br><span class="line">  <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PropertySourcesPropertyResolver env 依赖底层配置Prperty Resolver 处理工具。 追踪 getProperty 处理方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">getProperty</span><span class="params">(String key, Class&lt;T&gt; targetValueType, <span class="keyword">boolean</span> resolveNestedPlaceholders)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.propertySources != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (PropertySource&lt;?&gt; propertySource : <span class="keyword">this</span>.propertySources) &#123; <span class="comment">// 遍历所有的PropertySouce 资源列表内容，之前说过</span></span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Searching for key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; in PropertySource &#x27;&quot;</span> +</span><br><span class="line">            propertySource.getName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      Object value = propertySource.getProperty(key); <span class="comment">// 查找包含了 key 的 PropertySource value</span></span><br><span class="line">      <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resolveNestedPlaceholders &amp;&amp; value <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">          value = resolveNestedPlaceholders((String) value);</span><br><span class="line">        &#125;</span><br><span class="line">        logKeyFound(key, propertySource, value);</span><br><span class="line">        <span class="keyword">return</span> convertValueIfNecessary(value, targetValueType); <span class="comment">// ConversionService objectValue 进行数据转换</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Could not find key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; in any property source&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ConfigurablePropertyResolver-ConfigurablePropertyResolver"><a href="#ConfigurablePropertyResolver-ConfigurablePropertyResolver" class="headerlink" title="ConfigurablePropertyResolver ConfigurablePropertyResolver"></a>ConfigurablePropertyResolver ConfigurablePropertyResolver</h4><p>ConfigurablePropertyResolver 提供用户定制化的Property 属性对象转换方式， 通过 ConversionService定制化<br><img src="/images/20200831/ConversionService.png" alt="ConversionService"></p>
<ul>
<li>ConversionService 类型转换服务，sourceClassType to targetClassType，通过convert TargetType 类型转换<ul>
<li>CompositeConversionService 多ConversionService 组合转换方式</li>
<li>ConfigurableConversionService interface 继承 支持 Converter 类型转换配置 config</li>
<li>GenericConversionService 定义通用转换类型，分装不同的Converter 转换器<ul>
<li>FormattingConversionService 格式化Format 类型转换方式</li>
<li>TypeConverterConversionService type 类型转换</li>
<li>DefaultConversionService 默认注册不同 Conversion</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>GenericConverter 通用Converter 单一类型转换方式， 通过ConvertiblePair 提供转换类型信息。</p>
<h4 id="configure-配置-Env"><a href="#configure-配置-Env" class="headerlink" title="configure 配置 Env"></a>configure 配置 Env</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureEnvironment</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.addConversionService) &#123;</span><br><span class="line">    ConversionService conversionService = ApplicationConversionService.getSharedInstance();</span><br><span class="line">    environment.setConversionService((ConfigurableConversionService) conversionService);  <span class="comment">// env 注册 ConversionService</span></span><br><span class="line">  &#125;</span><br><span class="line">  configurePropertySources(environment, args);</span><br><span class="line">  configureProfiles(environment, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>ApplicationConversionService 注册配置String Number 不同类型转换器执行。 StanderEnv 添加类型转换器。</li>
<li>args 作为一种 PropertySource, 添加进入 Env 数据源中，我们知道 args 是优先级最高， source.addFirst</li>
<li>添加env 环境的 Profile 上下文，支持激活上下文配置方式。</li>
</ol>
<figure class="highlight plain"><figcaption><span>configurationProperties 添加 PropertySource, 事件注入, 后面Listener 通过监听事件注入 (这个下一篇再讲)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### bindingToSpringApplication binder 绑定SpringApplication 属性变量</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">protected void bindToSpringApplication(ConfigurableEnvironment environment) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    Binder.get(environment).bind(&quot;spring.main&quot;, Bindable.ofInstance(this));  &#x2F;&#x2F; spring.main 配置内容 绑定我们 SpringApplication 中</span><br><span class="line">  &#125;</span><br><span class="line">  catch (Exception ex) &#123;</span><br><span class="line">    throw new IllegalStateException(&quot;Cannot bind to SpringApplication&quot;, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Binder 对象属性绑定这， prefix “spaing.main” 配置绑定进入 Bindable 封装Instance 对象, 这里先不细说， 关注流程。</p>
<p>接下来执行, 上面Application 设置 spring.main 参数注入， 可能影响env 对象类型， 比如 spring.main 指定 web 类型转换 reactive, 需要转换 env 进入 ReactiveEnviroment 类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">  environment = <span class="keyword">new</span> EnvironmentConverter(getClassLoader()).convertEnvironmentIfNecessary(environment,</span><br><span class="line">      deduceEnvironmentClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>beanInfo加载判断, spring.beaninfo.ignore，lazy load 变得 代价较高</p>
<p>到这里 Enviroment 加载已经完成了， 后面是 ApplicationContext 加载过程， 第二章介绍 ApplicationListener env 事件监听， 底层后面专题沟通。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.yaoqijun.site/2020/08/29/SpringApplicationStarter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="joker">
      <meta itemprop="description" content="why so serious">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="joker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/29/SpringApplicationStarter/" class="post-title-link" itemprop="url">SpringApplication builder 启动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-29 01:46:07" itemprop="dateCreated datePublished" datetime="2020-08-29T01:46:07+08:00">2020-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-30 18:45:46" itemprop="dateModified" datetime="2020-08-30T18:45:46+08:00">2020-08-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/Spring/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这一章讲讲 SpringApplication app 应用启动方式，参考上一章 <a href="/2020/08/28/SpringBootJarLauncher/index.html">springJar资源加载</a>。<br>要启动一个SpringBoot应用， 通过构建一个 SpringApplication 我们引用， 同时提供了 SpringApplicationBuilder 构建器。这一章主要分析这两Class。</p>
<h4 id="SpringApplicationBuilder-Class-解析"><a href="#SpringApplicationBuilder-Class-解析" class="headerlink" title="SpringApplicationBuilder Class 解析"></a>SpringApplicationBuilder Class 解析</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SpringApplication application;    <span class="comment">// application SpringApplication 构建应用对象。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurableApplicationContext context; <span class="comment">// application 运行上下文， 熟悉的ApplicationContext 管理Spring 运行上下文。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SpringApplicationBuilder parent;    <span class="comment">// ApplicationContext 支持父子容器，支持属性的继承，记得 SpringCloud 通过父子容器，实现配置获取和覆盖。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean running = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Class&lt;?&gt;&gt; sources = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; defaultProperties = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ConfigurableEnvironment environment;    <span class="comment">// 配置环境运行上下文</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; additionalProfiles = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> registerShutdownHookApplied;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> configuredAsChild = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>

<p>其他通过标识Application 运行状态，build 通过 run 方法 启动运行SpringAplication 上下文。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.running.get()) &#123;</span><br><span class="line">        <span class="comment">// If already created we just return the existing context</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.context;</span><br><span class="line">    &#125;</span><br><span class="line">    configureAsChildIfNecessary(args);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.running.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.running) &#123;</span><br><span class="line">            <span class="comment">// If not already running copy the sources over and then run.</span></span><br><span class="line">            <span class="keyword">this</span>.context = build().run(args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.context;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureAsChildIfNecessary</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.configuredAsChild) &#123;</span><br><span class="line">        <span class="keyword">this</span>.configuredAsChild = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.registerShutdownHookApplied) &#123;</span><br><span class="line">            <span class="keyword">this</span>.application.setRegisterShutdownHook(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        initializers(<span class="keyword">new</span> ParentContextApplicationContextInitializer(<span class="keyword">this</span>.parent.run(args)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码比较清晰, 通过 build() 构建 SpringApplication, run(args) 启动我们的引用对象。<strong>这里 parent.run() 预先执行 ParentContextApplicationContexntInitializer 初始化接口，子容器创建添加 parentApplicationContext</strong></p>
<h4 id="SpringApplication-项目容器的启动"><a href="#SpringApplication-项目容器的启动" class="headerlink" title="SpringApplication 项目容器的启动"></a>SpringApplication 项目容器的启动</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    StopWatch stopWatch = <span class="keyword">new</span> StopWatch();  <span class="comment">// spring 内置StopWatch 用于统计 Spring Application 启动时间统计</span></span><br><span class="line">    stopWatch.start();</span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;  <span class="comment">// applicationContext 应用运行上下文对象, 后面初始化</span></span><br><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    configureHeadlessProperty();    <span class="comment">// java.awt.headless 设置运行环境，</span></span><br><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);    <span class="comment">// 获取 SpringApplication 构建监听上下文</span></span><br><span class="line">    listeners.starting();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line">        ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">        configureIgnoreBeanInfo(environment);       <span class="comment">// environment 运行上下文准备</span></span><br><span class="line">        Banner printedBanner = printBanner(environment);</span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        refreshContext(context);</span><br><span class="line">        afterRefresh(context, applicationArguments);    <span class="comment">// application context 刷新</span></span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">            <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">        &#125;</span><br><span class="line">        listeners.started(context);</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        listeners.running(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>headless, Headless模式是在缺少显示屏、键盘或者鼠标是的系统配置，时候一些图片处理类库使用</li>
<li>getListeners 这个是 SpringApplication应用启动类监听上下文。区别后面ApplicationContextEventListener监听。 应用启动的不同阶段，用户定制化一些逻辑，输出一些监听信息。</li>
<li>去除监听，干扰项。 应用启动流程比较简单<ul>
<li>env 运行环境对象 创建,初始化</li>
<li>ApplicationContext 创建</li>
<li>ApplicationContext 初始化</li>
<li>ContextRefresh 核心Bean 加载load</li>
<li>refreshAfter 加载一些CommandRunner Bean</li>
<li>运行 RunnerCommand</li>
</ul>
</li>
<li>最后对app 启动异常处理, handleRunFailure(exceptionReports) 处理异常结果。</li>
</ol>
<h5 id="SpringApplicationRunListener-容器运行启动监听者"><a href="#SpringApplicationRunListener-容器运行启动监听者" class="headerlink" title="SpringApplicationRunListener 容器运行启动监听者"></a>SpringApplicationRunListener 容器运行启动监听者</h5><p>SpringApplicationRunListeners 是SpinrgApplicationRunListener监听器的管理者, Facade 执行事件分发，下面是监听事件</p>
<ul>
<li>starting() starting 没有任何参数, 这个时候 env, context 还没有创建</li>
<li>environmentPrepared(ConfigurableEnvironment environment) {</li>
<li>contextPrepared(ConfigurableApplicationContext context)</li>
<li>contextLoaded(ConfigurableApplicationContext context)</li>
<li>started(ConfigurableApplicationContext context)</li>
<li>running(ConfigurableApplicationContext context)</li>
<li>failed(ConfigurableApplicationContext context, Throwable exception)</li>
</ul>
<p>SpringApplicationRunListener 可以用户自定义实现，完成定制化需求。同时有一个实现者，EventPublishingRunListener 用于分发Spring 内部事件，后面详细说明。<br>说说 SpringApplicationRunnerListener 初始化过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title">getRunListeners</span><span class="params">(String[] args)</span> </span>&#123;  <span class="comment">// 通过这个函数获取 Listeners</span></span><br><span class="line">    Class&lt;?&gt;[] types = <span class="keyword">new</span> Class&lt;?&gt;[] &#123; SpringApplication.class, String[].class &#125;;      // SpringApplicationRunListener 构造参数必须 springApplications, args</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringApplicationRunListeners(logger,</span><br><span class="line">            getSpringFactoriesInstances(SpringApplicationRunListener.class, types, <span class="keyword">this</span>, args));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, Class&lt;?&gt;[] parameterTypes, Object... args)</span> </span>&#123;</span><br><span class="line">    ClassLoader classLoader = getClassLoader();</span><br><span class="line">    Set&lt;String&gt; names = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(SpringFactoriesLoader.loadFactoryNames(type, classLoader));     <span class="comment">// 获取 spring.factory 配置文件 ClassName</span></span><br><span class="line">    List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names); <span class="comment">// 反射Construct 构造Listeners</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances); <span class="comment">// 比较Ordered 顺序方式, 执行列表</span></span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以用户定制化添加 ApplicationListener, META-INF spring.factories 添加定制化对的 Listener。</p>
<h4 id="SpringFactoriesLoader-factories-加载"><a href="#SpringFactoriesLoader-factories-加载" class="headerlink" title="SpringFactoriesLoader factories 加载"></a>SpringFactoriesLoader factories 加载</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">&quot;META-INF/spring.factories&quot;</span>; <span class="comment">// 加载固定spring.factories 文件位置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ClassLoader, MultiValueMap&lt;String, String&gt;&gt; cache = <span class="keyword">new</span> ConcurrentReferenceHashMap&lt;&gt;();  <span class="comment">// classloader 级别， 缓存不同property 属性配置</span></span><br></pre></td></tr></table></figure>

<p>可以看到，factoriesLader 缓存是基于 ClassLoader，应该为了应对多 ApplicationContext 不同通loader。 获取依赖jar FACTORIES_RESOURCE_LOCATION resource 配置文件, 通过 PropertiesLoaderUtils load 对应的Properties配置属性文件。OK</p>
<h4 id="AnnotationAwareOrderComparator"><a href="#AnnotationAwareOrderComparator" class="headerlink" title="AnnotationAwareOrderComparator"></a>AnnotationAwareOrderComparator</h4><p>Spring 通过AnnotationAwareOrderComparator进行对象排序, 继承来自 OrderComaprator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCompare</span><span class="params">(<span class="meta">@Nullable</span> Object o1, <span class="meta">@Nullable</span> Object o2, <span class="meta">@Nullable</span> OrderSourceProvider sourceProvider)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> p1 = (o1 <span class="keyword">instanceof</span> PriorityOrdered);   <span class="comment">// priorityOrdered 一定优先 Ordered, </span></span><br><span class="line">    <span class="keyword">boolean</span> p2 = (o2 <span class="keyword">instanceof</span> PriorityOrdered);</span><br><span class="line">    <span class="keyword">if</span> (p1 &amp;&amp; !p2) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p2 &amp;&amp; !p1) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i1 = getOrder(o1, sourceProvider);</span><br><span class="line">    <span class="keyword">int</span> i2 = getOrder(o2, sourceProvider);</span><br><span class="line">    <span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OrderedSourceProvider spring 提供排序对象转换工具，list 对象进行排序操作。<br>Ordered 递增排序方式， Ordered.LOWEST_PRECEDENCE = Interger.MAX_VALUE，而且默认的排序。 OrderComparator 通过 Order 继承获取排序数值， Annotation 通过获取Annotation 获取排序的 value。</p>
<h4 id="callRunner"><a href="#callRunner" class="headerlink" title="callRunner"></a>callRunner</h4><p>运行 ApplicationRunner, CommandLineRunner component 组件bean, 可能一些启动业务 Runner 在其中运行， 但是 bean applicationContext 不会再这里。</p>
<p>剩余 env, appplicationContext 创建，初始化，刷新，spring核心，后面讲。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="joker"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">joker</p>
  <div class="site-description" itemprop="description">why so serious</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/LiveAlone" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LiveAlone" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yaoqijunmail@foxmail.com" title="E-Mail → mailto:yaoqijunmail@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">joker</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
